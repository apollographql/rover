on:
  push:
    branches:
      - main
  pull_request:
  merge_group:

jobs:
  introspection_e2e:
    name: introspection E2E
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Install stable@stable toolchain
        uses: actions-rust-lang/setup-rust-toolchain@a0b538fa0b742a6aa35d6e2c169b4bd06d225a98 # v1.15.3
      - name: Install rover
        run: cargo build -r --bin rover
      - name: Check rover
        run: |
          export PATH="$PATH:./target/release"
          rover -V
      - name: Build Services
        run: cargo build -r -p regressions --example is_deprecated
      - name: Run Tests
        run: |
            ./target/release/examples/is_deprecated &
            echo $! > is_deprecated_service.pid
            cargo build
            cargo test --locked --package regressions --test cli_tests -- introspection_cli_tests
            kill $(cat is_deprecated_service.pid)

  connectors_e2e:
    name: connectors E2E
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Install stable@stable toolchain
        uses: actions-rust-lang/setup-rust-toolchain@a0b538fa0b742a6aa35d6e2c169b4bd06d225a98 # v1.15.3
      - name: Install rover
        run: cargo build -r --bin rover
      - name: Check rover
        run: |
          export PATH="$PATH:./target/release"
          rover -V
      - name: Run Tests
        run: |
            cargo build
            cargo test --locked --package regressions --test cli_tests -- connectors_cli_tests
            

